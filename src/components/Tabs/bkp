
import React, { useRef, useState, useEffect } from "react";
import {
  View,
  Text,
  TextInput,
  StyleSheet,
  Alert,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  FlatList,
} from "react-native";
import { Formik } from "formik";
import { pick } from "@react-native-documents/picker";
import { RichEditor, RichToolbar, actions } from "react-native-pell-rich-editor";
import { Dropdown } from "react-native-element-dropdown";
import ImagePicker from "react-native-image-crop-picker";
import Warning from "../../Alerts/Warning";
import Success from "../../Alerts/Success";
import Ionicons from "react-native-vector-icons/Ionicons";
import { fetchHR365HDMTicketFieldSettings } from "../../../backend/RequestAPI";

const CreateTicket = () => {
  const richText = useRef();
  const [showSuccess, setShowSuccess] = useState(false);
  const [warningMessage, setWarningMessage] = useState("");
  const [services, setServices] = useState([]);
  const [requestTypes, setRequestTypes] = useState([]);
  const [priorities, setPriorities] = useState([]);
  const [subServices, setSubServices] = useState([]);
  const [FNames, setFNames] = useState([]);
  const [loading, setLoading] = useState(true);
  const [requestFormType, setRequestFormType] = useState('');
  const requestFormTypeData = [
    { label: "form1", value: "form1" },
    { label: "form2", value: "form2" },
    { label: "form3", value: "form3" },
  ];

  const fetchOptions = async () => {
    try {
      const servicesData = [
        { label: "IT Support", value: "it_support" },
        { label: "HR", value: "hr" },
        { label: "Finance", value: "finance" },
      ];
      const requestTypesData = [
        { label: "Issue", value: "issue" },
        { label: "New Request", value: "new_request" },
        { label: "Change", value: "change" },
      ];
      const prioritiesData = [
        { label: "Low", value: "low" },
        { label: "Medium", value: "medium" },
        { label: "High", value: "high" },
      ];
      const subServicesData = [
        { label: "Email Access", value: "email_access" },
        { label: "System Access", value: "system_access" },
        { label: "Other", value: "other" },
      ];
      setTimeout(() => {
        setServices(servicesData);
        setRequestTypes(requestTypesData);
        setPriorities(prioritiesData);
        setSubServices(subServicesData);
        setLoading(false);
      }, 1000);
    } catch (error) {
      Alert.alert("Error", "Failed to load dropdown options");
      setLoading(false);
    }
  };

  const fetchTicketFields = async () => {
    const fetchedData = await fetchHR365HDMTicketFieldSettings();
        console.log(fetchedData, 'extractedFields===')

    const extractedFieldsOfUser = fetchedData?.TicketFieldsForUser?.split(',')
    const transformedFieldsOfUser = extractedFieldsOfUser?.map((i)=>{
      return {
          DisplayName: i,
          InternalName: i,
          Type: i,
          values: i,
          DefultValue: i,
          ListName: i,
          SelectedColumnName: i,
          ChoiceType: i,
          ShowType: i || "",
        };
    });
    console.log(transformedFieldsOfUser, 'extractedFields===')

    setFNames(transformedFieldsOfUser);
  }

  useEffect(() => {
    fetchOptions();
    fetchTicketFields();
  }, []);

  const openGallery = async () => {
    try {
      const image = await ImagePicker.openPicker({
        width: 300,
        height: 400,
        cropping: true,
        includeBase64: true,
      });
      const b64 = `data:${image.mime};base64,${image.data}`;
      richText.current?.insertImage(b64);
    } catch (error) {
      if (error.code !== 'E_PICKER_CANCELLED') {
        console.log('Gallery Error: ', error);
      }
    }
  };

  const openCamera = async () => {
    try {
      const image = await ImagePicker.openCamera({
        width: 300,
        height: 400,
        cropping: true,
        includeBase64: true,
      });
      const b64 = `data:${image.mime};base64,${image.data}`;
      richText.current?.insertImage(b64);
    } catch (error) {
      if (error.code !== 'E_PICKER_CANCELLED') {
        console.log('Camera Error: ', error);
      }
    }
  };

  const insertImage = () => {
    Alert.alert(
      'Insert Image',
      'Choose source',
      [
        {
          text: 'Camera',
          onPress: openCamera,
        },
        {
          text: 'Gallery',
          onPress: openGallery,
        },
        { text: 'Cancel', style: 'cancel' },
      ],
      { cancelable: true },
    );
  };

  const handleSubmitForm = async (values, { resetForm }) => {
    if (
      !values.title ||
      !values.service ||
      !values.requestType ||
      !values.priority ||
      !values.subService ||
      !values.description
    ) {
      setWarningMessage("Please fill all required fields");
      return;
    }
    setShowSuccess(true);
    resetForm();
  };

  return (
    <View style={{ flex: 1, backgroundColor: "#fff" }}>
      <ScrollView contentContainerStyle={styles.container}>
        <Formik
          initialValues={{
            title: "",
            service: "",
            requestType: "",
            priority: "",
            subServicel1: "",
            subServicel2: "",
            subServicel3: "",
            assetDetails: "",
            description: "",
            teams: "",
            attachments: [],
          }}
          onSubmit={handleSubmitForm}
        >
          {({ handleChange, handleBlur, handleSubmit, setFieldValue, values }) => (
            <>
              <Text style={[styles.label, {textAlign: 'center'}]}>Select Ticket Request Form</Text>
              <Dropdown
                style={styles.dropdown}
                placeholderStyle={styles.placeholder}
                selectedTextStyle={styles.selectedText}
                data={requestFormTypeData}
                labelField="label"
                valueField="value"
                placeholder="Select Ticket Request Form"
                value={requestFormType}
                itemContainerStyle={styles.dropdownItemContainer} 
                onChange={(item) => setRequestFormType(item.value)}
                renderRightIcon={() => (
                  <Ionicons name="chevron-down" size={18} color="#333" />
                )}
                containerStyle={styles.dropdownContainer}
                itemTextStyle={styles.dropdownItem}
              />
              {
                FNames?.map((item, index) => {
                  return item.InternalName == "Title" ? 
                    <>
                      <Text style={styles.label}>Title</Text>
                      <TextInput
                        style={styles.input}
                        onChangeText={handleChange("title")}
                        onBlur={handleBlur("title")}
                        value={values.title}
                        placeholder="Enter Title"
                        placeholderTextColor="#333333"
                      />
                    </>
                  : item.InternalName == "Priority" ? 
                    <>
                      <Text style={styles.label}>Priority</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={priorities}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Priority"
                        value={values.priority}
                        onChange={(item) => setFieldValue("priority", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "Request Type" ? 
                    <>
                      <Text style={styles.label}>Request Type</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={requestTypes}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Request Type"
                        value={values.requestType}
                        onChange={(item) => setFieldValue("requestType", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "Services" ? 
                    <>
                      <Text style={styles.label}>Service</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={services}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Service"
                        value={values.service}
                        onChange={(item) => setFieldValue("service", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "SubServices" ||
                    item.InternalName == "Sub Services" ||
                    item.InternalName == "Sub Services L1" ? 
                    <>
                      <Text style={styles.label}>Sub Service L1</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={subServices}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Sub Service"
                        value={values.subServicel1}
                        onChange={(item) => setFieldValue("subServicel1", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "SubServiceL2" ||
                  item.InternalName == "Sub Services L2" ? 
                    <>
                      <Text style={styles.label}>Sub Service L2</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={subServices}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Sub Service"
                        value={values.subServicel2}
                        onChange={(item) => setFieldValue("subServicel2", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "SubServiceL3" ||
                  item.InternalName == "Sub Services L3" ? 
                    <>
                      <Text style={styles.label}>Sub Service L3</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={subServices}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Sub Service"
                        value={values.subServicel3}
                        onChange={(item) => setFieldValue("subServicel3", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "Asset detail" ? 
                    <>
                      <Text style={styles.label}>Asset Detail</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={subServices}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Asset"
                        value={values.assetDetails}
                        onChange={(item) => setFieldValue("assetDetails", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "Teams" ? 
                    <>
                      <Text style={styles.label}>Teams</Text>
                      <Dropdown
                        style={styles.dropdown}
                        placeholderStyle={styles.placeholder}
                        selectedTextStyle={styles.selectedText}
                        data={subServices}
                        labelField="label"
                        valueField="value"
                        placeholder="Select Team"
                        value={values.teams}
                        onChange={(item) => setFieldValue("teams", item.value)}
                        renderRightIcon={() => (
                          <Ionicons name="chevron-down" size={18} color="#333" />
                        )}
                        containerStyle={styles.dropdownContainer}
                        itemTextStyle={styles.dropdownItem}
                      />
                    </>
                  : item.InternalName == "Ticket Description" ? 
                    <>
                      <Text style={styles.label}>Description</Text>
                      <RichEditor
                        ref={richText}
                        style={styles.richInput}
                        placeholder="Enter ticket description..."
                        placeholderTextColor="#333333"
                        initialContentHTML={values.description}
                        onChange={(text) => setFieldValue("description", text)}
                        editorStyle={{
                          backgroundColor: "#fff",
                          color: "#333333",
                          placeholderColor: "#333333",
                          cssText: "body {font-family: Roboto; font-size: 16px;}",
                        }}
                      />
                      <RichToolbar
                        editor={richText}
                        actions={[
                          actions.setBold,
                          actions.setItalic,
                          actions.setUnderline,
                          actions.insertOrderedList,
                          actions.insertBulletsList,
                          actions.heading1,
                          actions.heading2,
                          actions.heading3,
                          actions.setParagraph,
                          actions.insertLink,
                          actions.insertImage,
                          actions.insertVideo,
                          actions.insertCode,
                          actions.undo,
                          actions.redo,
                        ]}
                        onPressAddImage={insertImage}
                        iconMap={{
                          [actions.heading1]: ({ tintColor }) => (
                            <Text style={{ color: "#333333", fontWeight: 600, fontSize: 18, }}>H1</Text>
                          ),
                          [actions.heading2]: ({ tintColor }) => (
                            <Text style={{ color: "#333333", fontWeight: 600, fontSize: 18,}}>H2</Text>
                          ),
                          [actions.heading3]: ({ tintColor }) => (
                            <Text style={{ color: "#333333", fontWeight: 600, fontSize: 18, }}>H3</Text>
                          ),
                          [actions.setParagraph]: ({ tintColor }) => (
                            <Text style={{ color: "#333333", fontWeight: 600, fontSize: 18, }}>P</Text>
                          ),
                          [actions.insertCode]: ({ tintColor }) => (
                            <Text style={{ color: "#333333", fontWeight: 600, fontSize: 18, }}>{`</>`}</Text>
                          ),
                        }}
                        iconTint="#000"
                      />
                    </> 
                  :  ""
                })
              }
              <View style={styles.submissionWrapper}>
                <TouchableOpacity style={styles.submitBtn} onPress={handleSubmit}>
                  <Text style={styles.submitBtnText}>Create Ticket</Text>
                </TouchableOpacity>
                <TouchableOpacity
                  style={styles.attachmentBtn}
                  onPress={async () => {
                    try {
                      const result = await pick({
                        allowMultiSelection: true,
                        type: ["image/*"],
                      });
                      if (result && result.length > 0) {
                        setFieldValue("attachments", [...values.attachments, ...result]);
                      }
                    } catch (err) {
                      Alert.alert("File Error", err.message);
                    }
                  }}
                >
                  <Ionicons name="attach" size={26} color="#026367" style={{ marginLeft: 8 }} />
                </TouchableOpacity>
              </View>

              {values.attachments.length > 0 && (
                <View style={[styles.attachmentsContainer, { marginBottom: 50 }]}>
                  {values.attachments.map((item, index) => (
                    <View key={index} style={styles.attachmentItem}>
                      <Text style={styles.attachmentName} numberOfLines={1}>
                        {item.name}
                      </Text>
                      <TouchableOpacity
                        onPress={() => {
                          const updated = values?.attachments?.filter((_, i) => i !== index);
                          setFieldValue("attachments", updated);
                        }}
                      >
                        <Ionicons name="close" size={21} color="#026367" />
                      </TouchableOpacity>
                    </View>
                  ))}
                </View>
              )}
            </>
          )}
        </Formik>
      </ScrollView>
      <Warning
        message={warningMessage}
        visible={!!warningMessage}
        onHide={() => setWarningMessage("")}
      />
      <Success
        message="Ticket created successfully!"
        visible={showSuccess}
        onHide={() => setShowSuccess(false)}
      />
    </View>
  );
};

export default CreateTicket;

const styles = StyleSheet.create({
  container: {
    padding: 20,
    backgroundColor: "#fff",
    flexGrow: 1,
    paddingBottom: 100,
  },
  loader: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    padding: 20,
  },
  text: {
    fontFamily: "Roboto",
    fontSize: 14,
    color: "#333333",
  },
  label: {
    fontFamily: "Roboto",
    fontWeight: "bold",
    fontSize: 17,
    marginTop: 1,
    marginBottom: 5,
    color: "#333333",
  },
  input: {
    borderWidth: 1,
    borderColor: "#ccc",
    paddingHorizontal: 12,
    paddingVertical: 10,
    fontSize: 16,
    backgroundColor: "#fff",
    fontFamily: "Roboto",
    color: "#333333",
    marginBottom: 6,
  },
  dropdown: {
    borderWidth: 1,
    borderColor: "#ccc",
    paddingHorizontal: 10,
    height: 44,
    backgroundColor: "#fff",
    marginBottom: 6,
  },
  placeholder: {
    color: "#333333",
    fontSize: 16,
    fontFamily: "Roboto",
  },
  selectedText: {
    fontSize: 16,
    color: "#333333",
    fontFamily: "Roboto",
  },
  dropdownContainer: {
    backgroundColor: "#fff",
    padding: 0,
  },
  dropdownItem: {
    color: "#333333",
    fontFamily: "Roboto",
    fontSize: 16,
  },
  dropdownItemContainer: {
    padding: 0,
  },
  richInput: {
    borderWidth: 1,
    borderColor: "#ccc",
    minHeight: 120,
    backgroundColor: "#fff",
    padding: 8,
    fontFamily: "Roboto",
    color: "#333333",
  },
  attachmentText: {
    color: "#fff",
    fontFamily: "Roboto",
    fontSize: 16,
  },
  submissionWrapper: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    marginTop: 15,
  },
  submitBtn: {
    backgroundColor: "#026367",
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderRadius: 6,
    alignItems: "center",
    justifyContent: "center",
    width: "85%",
  },
  submitBtnText: {
    color: "#fff",
    fontWeight: "bold",
    fontSize: 16,
    fontFamily: "Roboto",
  },
  attachmentBtn: {
    padding: 12,
    borderRadius: 6,
    alignItems: "center",
    justifyContent: "center",
    flexDirection: "row",
    width: "15%",
  },
  attachmentsContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    marginTop: 10,
  },
  attachmentItem: {
    width: '49%',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#f5f5f5',
    borderColor: '#ccc',
    borderWidth: 1,
    padding: 10,
    marginBottom: 6,
  },
  attachmentName: {
    flex: 1,
    marginRight: 8,
    color: '#333',
  },
});